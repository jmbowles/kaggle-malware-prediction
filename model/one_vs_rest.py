from __future__ import print_function
"""

"""
from pyspark.ml import Pipeline
from pyspark.ml.feature import FeatureHasher
from pyspark.ml.classification import OneVsRest, LogisticRegression
from pyspark.ml.evaluation import MulticlassClassificationEvaluator

import pyspark.sql.functions as F

pipeline_path = "output/one_vs_rest_pipeline"
pipeline_model_path = "output/one_vs_rest_pipeline_model"

#selected_cols = ["Platform", "AvSigVersion", "AVProductStatesIdentifier", "CountryIdentifier", "SMode", "Wdft_RegionIdentifier", "Census_OSVersion", "OsBuildLab", "Census_IsTouchEnabled", "Census_IsPenCapable", "Census_IsSecureBootEnabled"]
#selected_cols = ["Platform", "AvSigVersion", "AVProductStatesIdentifier", "CountryIdentifier", "Census_OSVersion", "Census_FirmwareManufacturerIdentifier", "Census_FirmwareVersionIdentifier", "Census_OSArchitecture"]
selected_cols = ["Platform", "AvSigVersion", "AVProductStatesIdentifier", "CountryIdentifier", "Census_OSVersion", "Derived_Firmware", "Derived_Processor", "Derived_Installer", "Wdft_IsGamer", "Census_IsTouchEnabled", "Census_IsSecureBootEnabled"]

print("Selected Features Count: {0}".format(len(selected_cols)))
print("Selected Features: {0}".format(selected_cols))

df = spark.read.load("../datasets/train.csv", format="csv", sep=",", inferSchema="true", header="true")
df.cache()
df = df.withColumn("Derived_Firmware", F.concat(df.Census_FirmwareManufacturerIdentifier, F.lit("_"), df.Census_FirmwareVersionIdentifier))
df = df.withColumn("Derived_Processor", F.concat(df.Census_ProcessorManufacturerIdentifier, F.lit("_"), df.Census_ProcessorModelIdentifier))
df = df.withColumn("Derived_Installer", F.concat(df.Census_OSInstallTypeName, F.lit("_"), df.Census_OSInstallLanguageIdentifier))

print("Selected Features without Exclusions Count: {0}".format(len(selected_cols)))

print("Creating Splits")
train, test = df.randomSplit([0.7, 0.3], 51)

print("Building Pipeline")
classifier = LogisticRegression(regParam=0.01, maxIter=100, aggregationDepth=2, fitIntercept=True, family="binomial", elasticNetParam=0.0)
stages = []
stages.append(FeatureHasher(numFeatures=32768, inputCols=selected_cols, outputCol="features", categoricalCols=selected_cols))
stages.append(OneVsRest(classifier=classifier, parallelism=4, featuresCol="features", labelCol="HasDetections", predictionCol="prediction"))
pipeline = Pipeline(stages=stages)

print("Fitting -> Training Data")
pipeline_model = pipeline.fit(train)

print("Fitting -> Test Data")
predictions = pipeline_model.transform(test)
predictions.select("HasDetections", "MachineIdentifier", "prediction").show(truncate=False)

print("Computing Multiclass Accuracy")
evaluator = MulticlassClassificationEvaluator(labelCol="HasDetections", predictionCol="prediction", metricName="accuracy")
accuracy = evaluator.evaluate(predictions)
print("Test set accuracy = " + str(accuracy))

print("Saving Pipeline")
pipeline.write().overwrite().save(pipeline_path)

print("Saving Pipeline Model")
pipeline_model.write().overwrite().save(pipeline_model_path)

#print("Saving Predictions")
#predictions.write.saveAsTable("one_vs_rest_predictions", format="parquet", mode="overwrite", path="output/tables/one_vs_rest/predictions")




