from __future__ import print_function

from pyspark.ml.feature import FeatureHasher
from pyspark.ml.stat import ChiSquareTest
from pyspark.ml.feature import ChiSqSelector
from pyspark.ml.linalg import Vectors

from pyspark.sql import Column
import pyspark.sql.functions as F


df = spark.read.load("/Users/jmbowles/Development/datasets/kaggle/malware-prediction/train.csv", format="csv", sep=",", inferSchema="true", header="true")
df.cache()

all_columns = df.columns
label_col = ["HasDetections"]
meta_cols = ["MachineIdentifier"]
#feature_cols = ["SkuEdition", "ProductName", "AVProductsEnabled", "IsBeta", "Platform", "Census_DeviceFamily", "Census_OSInstallTypeName"]
feature_cols = list(set(all_columns) - set(label_col) - set(meta_cols))
ordered_cols = list(label_col + meta_cols + feature_cols)

#hasher = FeatureHasher(numFeatures=len(feature_cols), inputCols=feature_cols, outputCol="features",  categoricalCols=feature_cols)
hasher = FeatureHasher(numFeatures=len(feature_cols), inputCols=feature_cols, outputCol="features",  categoricalCols=feature_cols)
df_features = df.sample(fraction=0.50, seed=3)
df_features = df.select(*ordered_cols)
df_features = hasher.transform(df_features)

selector = ChiSqSelector(numTopFeatures=25, labelCol="HasDetections", featuresCol="features", outputCol="selectedFeatures")
model = selector.fit(df_features)
model_df = model.transform(df_features)
model.selectedFeatures
print("******    ChiSquare Selected Features   ******")
[feature_cols[i] for i in model.selectedFeatures]